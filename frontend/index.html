<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Story Maker for Grandparents</title>
   <style>
       @import url('https://fonts.googleapis.com/css2?family=Crimson+Text:wght@400;600&family=Inter:wght@300;400;500&display=swap');
      
       * {
           margin: 0;
           padding: 0;
           box-sizing: border-box;
       }
      
       body {
           font-family: 'Inter', sans-serif;
           background: linear-gradient(135deg, #f5f1e8 0%, #faf8f3 50%, #f0ede4 100%);
           min-height: 100vh;
           padding: 20px;
           display: flex;
           align-items: center;
           justify-content: center;
       }
      
       .container {
           max-width: 500px;
           width: 100%;
           background: rgba(255, 255, 255, 0.9);
           backdrop-filter: blur(10px);
           border-radius: 24px;
           padding: 40px 30px;
           box-shadow:
               0 20px 40px rgba(139, 69, 19, 0.08),
               0 8px 16px rgba(160, 82, 45, 0.04),
               inset 0 1px 0 rgba(255, 255, 255, 0.8);
           border: 1px solid rgba(222, 184, 135, 0.3);
           text-align: center;
       }
      
       .header {
           margin-bottom: 30px;
       }
      
       .title {
           font-family: 'Crimson Text', serif;
           font-size: 2.2em;
           color: #8b4513;
           font-weight: 600;
           margin-bottom: 8px;
           text-shadow: 0 2px 4px rgba(139, 69, 19, 0.1);
       }
      
       .subtitle {
           font-size: 1.1em;
           color: #a0522d;
           font-weight: 300;
           letter-spacing: 0.5px;
       }
      
       .description {
           margin: 25px 0;
           padding: 20px;
           background: linear-gradient(135deg, #faf8f3 0%, #f5f1e8 100%);
           border-radius: 16px;
           border: 1px solid rgba(222, 184, 135, 0.2);
       }
      
       .description p {
           color: #6b4423;
           font-size: 1.05em;
           line-height: 1.6;
           margin-bottom: 15px;
       }
      
       .examples {
           font-size: 0.95em;
           color: #8b6f47;
           font-style: italic;
           line-height: 1.4;
       }
      
       .recording-area {
           margin: 30px 0;
       }
      
       .record-button {
           background: linear-gradient(135deg, #cd853f 0%, #d2b48c 50%, #daa520 100%);
           border: none;
           border-radius: 50%;
           width: 120px;
           height: 120px;
           display: flex;
           align-items: center;
           justify-content: center;
           margin: 20px auto;
           cursor: pointer;
           transition: all 0.3s ease;
           box-shadow:
               0 8px 24px rgba(205, 133, 63, 0.3),
               0 4px 8px rgba(210, 180, 140, 0.2),
               inset 0 2px 4px rgba(255, 255, 255, 0.3);
           font-size: 48px;
           color: white;
           text-shadow: 0 2px 4px rgba(139, 69, 19, 0.3);
       }
      
       .record-button:hover {
           transform: translateY(-2px);
           box-shadow:
               0 12px 32px rgba(205, 133, 63, 0.4),
               0 6px 12px rgba(210, 180, 140, 0.3),
               inset 0 2px 4px rgba(255, 255, 255, 0.4);
       }
      
       .record-button:active {
           transform: translateY(0);
       }
      
       .record-button.recording {
           background: linear-gradient(135deg, #dc143c 0%, #ff6347 50%, #ff4500 100%);
           animation: pulse 1.5s infinite;
       }
      
       .record-button:disabled {
           opacity: 0.6;
           cursor: not-allowed;
           transform: none;
       }
      
       @keyframes pulse {
           0%, 100% { transform: scale(1); }
           50% { transform: scale(1.05); }
       }
      
       .status {
           margin: 20px 0;
           min-height: 60px;
           display: flex;
           flex-direction: column;
           align-items: center;
           justify-content: center;
       }
      
       .status-text {
           font-size: 1.1em;
           color: #8b4513;
           font-weight: 500;
           margin-bottom: 8px;
       }
      
       .timer {
           font-size: 1.4em;
           color: #a0522d;
           font-weight: 600;
           font-family: 'Courier New', monospace;
       }
      
       .timer.recording {
           color: #dc143c;
       }
      
       .controls {
           margin-top: 20px;
       }
      
       .stop-button, .generate-button {
           background: linear-gradient(135deg, #8b4513 0%, #a0522d 100%);
           color: white;
           border: none;
           padding: 12px 28px;
           border-radius: 25px;
           font-size: 1.1em;
           font-weight: 500;
           cursor: pointer;
           transition: all 0.3s ease;
           box-shadow: 0 4px 12px rgba(139, 69, 19, 0.3);
           margin: 5px;
       }
      
       .generate-button {
           background: linear-gradient(135deg, #8b4513 0%, #a0522d 50%, #cd853f 100%);
           font-size: 1.2em;
           font-weight: 600;
           padding: 15px 32px;
       }
      
       .stop-button:hover, .generate-button:hover {
           background: linear-gradient(135deg, #a0522d 0%, #8b4513 100%);
           transform: translateY(-1px);
           box-shadow: 0 6px 16px rgba(139, 69, 19, 0.4);
       }
      
       .stop-button:disabled, .generate-button:disabled {
           opacity: 0.6;
           cursor: not-allowed;
           transform: none;
       }
      
       .waveform {
           display: none;
           margin: 15px 0;
           height: 40px;
           background: linear-gradient(135deg, #f5f1e8 0%, #faf8f3 100%);
           border-radius: 20px;
           padding: 8px;
           border: 1px solid rgba(222, 184, 135, 0.3);
       }
      
       .wave-bars {
           display: flex;
           align-items: center;
           justify-content: center;
           height: 100%;
           gap: 3px;
       }
      
       .wave-bar {
           background: linear-gradient(135deg, #cd853f 0%, #d2b48c 100%);
           width: 4px;
           border-radius: 2px;
           animation: wave 1.5s infinite ease-in-out;
       }
      
       .wave-bar:nth-child(2) { animation-delay: 0.1s; }
       .wave-bar:nth-child(3) { animation-delay: 0.2s; }
       .wave-bar:nth-child(4) { animation-delay: 0.3s; }
       .wave-bar:nth-child(5) { animation-delay: 0.4s; }
      
       @keyframes wave {
           0%, 40%, 100% { height: 8px; }
           20% { height: 24px; }
       }
      
       .connection-status {
           position: fixed;
           top: 10px;
           right: 10px;
           padding: 8px 16px;
           border-radius: 20px;
           font-size: 0.9em;
           font-weight: 500;
       }
      
       .connection-status.connected {
           background: #d4edda;
           color: #155724;
           border: 1px solid #c3e6cb;
       }
      
       .connection-status.disconnected {
           background: #f8d7da;
           color: #721c24;
           border: 1px solid #f1b0b7;
       }
      
       .loading {
           display: none;
           margin: 20px 0;
       }
      
       .spinner {
           border: 3px solid #f3f3f3;
           border-top: 3px solid #8b4513;
           border-radius: 50%;
           width: 40px;
           height: 40px;
           animation: spin 1s linear infinite;
           margin: 0 auto;
       }
      
       @keyframes spin {
           0% { transform: rotate(0deg); }
           100% { transform: rotate(360deg); }
       }
      
       .hidden {
           display: none !important;
       }
   </style>
</head>
<body>
   <div class="connection-status" id="connectionStatus">Checking connection...</div>
  
   <div class="container">
       <div class="header">
           <h1 class="title">Story Maker</h1>
           <p class="subtitle">for Grandparents</p>
       </div>
      
       <div class="description">
           <p>Create a magical picture book for your grandchildren! Simply record your story idea and watch it come to life.</p>
           <div class="examples">
               Try: "A bunny who bakes the best cookies" or "A dragon who's afraid of the dark"
           </div>
       </div>
      
       <div class="recording-area">
           <button class="record-button" id="recordButton">🎤</button>
          
           <div class="waveform" id="waveform">
               <div class="wave-bars">
                   <div class="wave-bar"></div>
                   <div class="wave-bar"></div>
                   <div class="wave-bar"></div>
                   <div class="wave-bar"></div>
                   <div class="wave-bar"></div>
               </div>
           </div>
          
           <div class="status" id="status">
               <div class="status-text" id="statusText">Press the microphone to start recording</div>
               <div class="timer" id="timer">0:00</div>
           </div>
          
           <div class="loading" id="loading">
               <div class="spinner"></div>
               <div style="margin-top: 10px; color: #8b4513;">Creating your magical story...</div>
           </div>
          
           <div class="controls">
               <button class="stop-button" id="stopButton" style="display: none;">Stop Recording</button>
               <button class="generate-button" id="generateButton" style="display: none;">Create My Story</button>
           </div>
       </div>

       <div id="storySlider" style="display:none; margin-top: 20px; text-align:center;">
        <button id="prevPage">◀</button>
        <img id="sliderImage" src="" style="max-width:100%; border-radius:12px; margin:10px 0;" />
        <p id="sliderCaption" style="color:#6b4423;"></p>
        <button id="nextPage">▶</button>
    </div>

   </div>


   <script>
       const BACKEND_URL = 'http://localhost:5002';
      
       class StoryRecorder {
           constructor() {
               this.mediaRecorder = null;
               this.audioChunks = [];
               this.startTime = 0;
               this.timerInterval = null;
               this.isRecording = false;
               this.recordedAudio = null;
              
               this.recordButton = document.getElementById('recordButton');
               this.stopButton = document.getElementById('stopButton');
               this.generateButton = document.getElementById('generateButton');
               this.statusText = document.getElementById('statusText');
               this.timer = document.getElementById('timer');
               this.waveform = document.getElementById('waveform');
               this.loading = document.getElementById('loading');
               this.connectionStatus = document.getElementById('connectionStatus');
              
               this.initializeEventListeners();
               this.checkBackendConnection();
           }
          
           async checkBackendConnection() {
               try {
                   const response = await fetch(`${BACKEND_URL}/test`);
                   const data = await response.json();
                  
                   this.connectionStatus.textContent = '✅ Connected to backend';
                   this.connectionStatus.className = 'connection-status connected';
                   console.log('Backend connection successful:', data);
                  
               } catch (error) {
                   this.connectionStatus.textContent = '❌ Backend not connected';
                   this.connectionStatus.className = 'connection-status disconnected';
                   console.error('Backend connection failed:', error);
                  
                   this.statusText.textContent = 'Backend not running. Please start the Flask server.';
                   this.recordButton.disabled = true;
               }
           }
          
           initializeEventListeners() {
               this.recordButton.addEventListener('click', () => this.startRecording());
               this.stopButton.addEventListener('click', () => this.stopRecording());
               this.generateButton.addEventListener('click', () => this.generateStory());
           }
          
           async startRecording() {
               try {
                   console.log('Starting recording...');
                  
                   const stream = await navigator.mediaDevices.getUserMedia({
                       audio: {
                           echoCancellation: true,
                           noiseSuppression: true,
                           sampleRate: 44100
                       }
                   });
                  
                   // Check if MediaRecorder supports webm
                   let mimeType = 'audio/webm;codecs=opus';
                   if (!MediaRecorder.isTypeSupported(mimeType)) {
                       mimeType = 'audio/webm';
                   }
                   if (!MediaRecorder.isTypeSupported(mimeType)) {
                       mimeType = 'audio/mp4';
                   }
                  
                   console.log('Using MIME type:', mimeType);
                  
                   this.mediaRecorder = new MediaRecorder(stream, { mimeType });
                  
                   this.audioChunks = [];
                   this.mediaRecorder.ondataavailable = (event) => {
                       if (event.data.size > 0) {
                           this.audioChunks.push(event.data);
                       }
                   };
                  
                   this.mediaRecorder.onstop = () => {
                       const audioBlob = new Blob(this.audioChunks, { type: mimeType });
                       this.handleRecordingComplete(audioBlob);
                       stream.getTracks().forEach(track => track.stop());
                   };
                  
                   this.mediaRecorder.start(100); // Collect data every 100ms
                   this.isRecording = true;
                   this.startTime = Date.now();
                  
                   this.updateUIForRecording();
                   this.startTimer();
                  
               } catch (error) {
                   console.error('Error accessing microphone:', error);
                   this.statusText.textContent = 'Could not access microphone. Please allow microphone access.';
                  
                   if (error.name === 'NotAllowedError') {
                       this.statusText.textContent = 'Microphone access denied. Please allow microphone access and refresh.';
                   }
               }
           }
          
           stopRecording() {
               if (this.mediaRecorder && this.isRecording) {
                   console.log('Stopping recording...');
                   this.mediaRecorder.stop();
                   this.isRecording = false;
                   this.stopTimer();
                   this.updateUIForStopped();
               }
           }
          
           startTimer() {
               this.timerInterval = setInterval(() => {
                   const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
                   const minutes = Math.floor(elapsed / 60);
                   const seconds = elapsed % 60;
                   this.timer.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
               }, 1000);
           }
          
           stopTimer() {
               if (this.timerInterval) {
                   clearInterval(this.timerInterval);
                   this.timerInterval = null;
               }
           }
          
           updateUIForRecording() {
               this.recordButton.classList.add('recording');
               this.recordButton.textContent = '⏸';
               this.statusText.textContent = 'Recording your story idea...';
               this.timer.classList.add('recording');
               this.stopButton.style.display = 'inline-block';
               this.waveform.style.display = 'block';
               this.generateButton.style.display = 'none';
           }
          
           updateUIForStopped() {
               this.recordButton.classList.remove('recording');
               this.recordButton.textContent = '🎤';
               this.statusText.textContent = 'Great! Ready to create your story';
               this.timer.classList.remove('recording');
               this.stopButton.style.display = 'none';
               this.waveform.style.display = 'none';
               this.generateButton.style.display = 'inline-block';
           }
          
           handleRecordingComplete(audioBlob) {
               this.recordedAudio = audioBlob;
               console.log('Recording complete. Blob size:', audioBlob.size, 'bytes');
               console.log('Audio type:', audioBlob.type);
           }
          
           async generateStory() {
               if (!this.recordedAudio) {
                   alert('Please record your story idea first!');
                   return;
               }
              
               console.log('Starting story generation...');
              
               // Show loading state
               this.statusText.textContent = 'Creating your magical story...';
               this.generateButton.style.display = 'none';
               this.loading.style.display = 'block';
               this.recordButton.disabled = true;
              
               try {
                   // Create form data to send audio file
                   const formData = new FormData();
                   formData.append('audio', this.recordedAudio, 'recording.webm');
                  
                   console.log('Sending request to backend...');
                  
                   // Send to Flask backend
                   const response = await fetch(`${BACKEND_URL}/api/create-story`, {
                       method: 'POST',
                       body: formData
                   });
                  
                   console.log('Response status:', response.status);
                  
                   if (!response.ok) {
                       const errorText = await response.text();
                       throw new Error(`Server error (${response.status}): ${errorText}`);
                   }
                  
                   const result = await response.json();
                   console.log('Story creation result:', result);
                  
                   if (result.success) {
                       this.displayStory(result);
                   } else {
                       throw new Error(result.error || 'Unknown error from server');
                   }
                  
               } catch (error) {
                   console.error('Error creating story:', error);
                  
                   this.statusText.textContent = 'Sorry, something went wrong. Please try again.';
                   this.loading.style.display = 'none';
                   this.generateButton.style.display = 'inline-block';
                   this.recordButton.disabled = false;
                  
                   // Show user-friendly error
                   if (error.message.includes('Failed to fetch')) {
                       alert('Could not connect to server. Make sure the Flask backend is running on port 5000.');
                   } else {
                       alert('Error creating story: ' + error.message);
                   }
               }
           }
          
                displayStory(result) {
                    console.log('Story created successfully!', result);
                    console.log('Full backend result:', result); // helpful for debugging
                    
                    this.loading.style.display = 'none';
                    this.statusText.textContent = 'Story created successfully!';
                    
                    // Creates preview container
                    const preview = document.createElement('div');
                    preview.style.cssText = `
                    margin-top: 20px;
                    padding: 20px;
                    background: #f9f9f9;
                    border-radius: 12px;
                    text-align: left;
                    border: 1px solid #ddd;
                    `;
                    
                preview.innerHTML = `
                <h3 style="color: #8b4513; margin-bottom: 15px;">Your Story Preview</h3>
                <p><strong>Transcript:</strong> "${result.transcript}"</p>
                <p><strong>Pages generated:</strong> ${result.pages.length}</p>
                <div style="margin-top: 15px;">
                    ${result.pages.map((page) => `
                        <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 8px;">
                            <strong>Page ${page.page_number}:</strong> ${page.narration || page.content || 'No text provided'}
                            <br><small style="color: #666;">Image: ${page.url}</small>
                            </div>
                            `).join('')}
                            </div>
                            <button onclick="this.parentElement.remove(); storyRecorder.resetInterface();"
                            style="margin-top: 15px; padding: 8px 16px; background: #8b4513; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            Create Another Story
                            </button>
                            `;
                        
                        this.container = document.querySelector('.container');
                        this.container.appendChild(preview);
                        
                        //flipbook/slider setup
                        const slider = document.getElementById('storySlider');
                        const sliderImage = document.getElementById('sliderImage');
                        const sliderCaption = document.getElementById('sliderCaption');
                        const prevButton = document.getElementById('prevPage');
                        const nextButton = document.getElementById('nextPage');
                        
                        let currentPage = 0;
                        const pages = result.pages;
                        
                        function showPage(index) {
                            if (index < 0) index = pages.length - 1;
                            if (index >= pages.length) index = 0;
                            currentPage = index;
                            sliderImage.src = `${BACKEND_URL}${pages[currentPage].url}`;
                            sliderCaption.textContent = pages[currentPage].narration || pages[currentPage].content || 'No text provided';
                        }
                        
                        showPage(0);
                        slider.style.display = 'block';
                        prevButton.onclick = () => showPage(currentPage - 1);
                        nextButton.onclick = () => showPage(currentPage + 1);
                    }

            
           resetInterface() {
               this.recordButton.style.display = 'inline-block';
               this.recordButton.disabled = false;
               this.generateButton.style.display = 'none';
               this.statusText.textContent = 'Press the microphone to start recording';
               this.timer.textContent = '0:00';
               this.timer.classList.remove('recording');
               this.recordedAudio = null;
               this.loading.style.display = 'none';
           }
       }
      
       // Global variable for reset button access
       let storyRecorder;
      
       // Initialize the recorder when the page loads
       document.addEventListener('DOMContentLoaded', () => {
           storyRecorder = new StoryRecorder();
       });
   </script>
</body>
</html>